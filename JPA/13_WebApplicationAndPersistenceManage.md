## 13. 웹 애플리케이션과 영속성 관리

### 13.1 트랜잭션 범위의 영속성 컨텍스트

#### 13.1.1 스프링 컨테이너의 기본 전략

스프링 컨테이너는 트랜잭션 범위의 영속성 컨텍스트 전략을 기본으로 사용한다. 트랜잭션을 시작할 때 영속성 컨텍스트를 생성하고 트랜잭션이 끝날 때 영속성 컨텍스트를 종료한다. 그리고 같은 트랜잭션 안에서는 항상 같은 영속성 컨텍스트에 접근한다.

### 13.2 준영속 상태와 지연 로딩

트랜잭션은 보통 서비스 계층에서 시작하므로 서비스와 레파지토리 계층에서는 영속성 컨텍스트에 관리되면서 영속 상태를 유지하지만 프리젠테이션 계층에서는 준영속 상태가 된다.

- 준영속 상태와 변경 감지

  변경 감지 기능은 영속성 컨텍스트가 살아 있는 트랜잭션 범위 까지만 동작하고 영속성 컨텍스트가 종료된 프리젠테이션 계층에서는 동작하지 않는다.

- 준영속 상태와 지연 로딩

  준영속 상태에서는 지연 로딩 기능이 동작하지 않는다. 준영속 상태에서는 영속성 컨텍스트가 없으므로 지연 로딩을 할 수 없다.

  준영 속상태의 지연 로딩 문제를 해결하는 방법

  - 뷰가 필요한 엔티티를 미리 로딩
  - OSIV를 사용해서 엔티티를 항상 영속 상태로 유지하는 방법

  뷰가 필요한 엔티티를 미리로딩하는 방법

  - 글로벌 패치 전략 수정
  - JPQL 패치 조인
  - 강제로 초기화

#### 13.2.1 글로벌 페치 전략 수정

글로벌 패치 전략을 지연로딩에서 즉시로딩으로 변경하면 된다.

###### 글로벌 페치 전략에 즉시 로딩 사용시 단점

- 사용하지 않는 엔티티를 로딩한다

  어떤 경우에는 필요하지 않는데 사용하지 않아도 조회하게 된다

- N + 1 문제가 발생한다

  JPA가 JPQL을 분석해서 SQL을 생성할 떄는 글로벌 페치 전략을 참고하지 않고 오직 JPQL 자체만 사용한다. 따라서 엔티티를 리스트로 조회할때 ManyToOne에 해당하는 엔티티를 하나씩 조회한다.

#### 13.2.2 JPQL 페치 조인

JPQL을 호출하는 시점에 함께 로딩할 엔티티를 선택할 수 있다.

- JPQL 페치 조인의 단점

  무분별하게 사용하면 화면에 맞춘 레파지토리가 증가할 수 있다. 화면 별 필요한 메소드를 만들어 호출할 수 있지만 뷰와 레파지토리간의 논리적인 의존관계가 생긴다

#### 13.2.3 강제로 초기화

영속성 컨텍스트가 살아있을 때 프리젠테이션 계층이 필요한 엔티티를 강제로 초기화해서 반환하는 방법

하이버네이트를 사용하면 `initialize()` 메소드를 사용해서 프록시를 강제로 초기화할 수도 있다. 프록시를 초기화하는 역할을 서비스 계층이 담당하면 뷰가 필요한 엔티티에 따라 서비스 계층의 로직을 변경해야한다. 프리젠테이션 계층이 서비스 계층을 침범하는 상황이다

#### 13.2.4 FACADE 계층 추가

프리젠테이션 계층과 서비스 계층 사이에 FACADE 계층을 하나더 두는 방법 뷰를 위한 프록시 초기화는 이곳에서 담당한다

- 프리젠테이션 계층과 도메인 모델 계층 간의 논리적 의존성을 분리
- 프리젠테이션 계층에서 필요한 프록시 객체를 초기화
- 서비스 계층을 호출해서 비즈니시 로직 실행
- 레파지토리를 직접 호출해 뷰가 요구하는 엔티티를 찾는다

단점은 중간에 계층이 하나 더 끼어든다는 점이다. 결국 더 많은 코드를 작성해야 한다. FACADE에는 단순히 서비스 계층을 호출만 하는 위임 코드가 상당히 많을 것이다.

#### 13.2.5 준영속 상태와 지연 로딩의 문제점

모든 문제는 엔티티가 프리젠테이션 계층에서 준영속 상태이기 때문에 발생. 영속성 컨텍스트를 뷰까지 살아있게 열어두는 것이 OSIV이다.

### 13.3 OSIV

OSIV(Open Session In View)는 영속성 컨텍스트를 뷰까지 열어둔다는 뜻이다

#### 13.3.1 과거 OSIV: 요청 당 트랜잭션

클라이언트의 요청이 들어오자마자 서블릿 필터나 스프링 인터셉터에서 트랜젝션을 시작하고 요청이 끝날 때 트랜잭션도 끝내는 것

##### 요청 당 트랜잭션 방식의 OSIV 문제점

프리젠테이션 계층이 엔티티를 변경할 수 있다. 이를 해결하려면 프리젠테이션 계층에서 엔티티를 수정하지 못하게 막으면 된다

- 엔티티를 읽기 전용 인터페이스로 제공
- 엔티티 레핑
- DTO만 반환

##### 엔티티를 읽기 전용 인터페이스로 제공

읽기 전용 메소드만 있는 인터페이스를 제공한다

##### 엔티티레핑

엔티티의 읽기 전용 메소드만 가지고 있는 엔티티를 감싼 객체를 만들고 이것을 프리젠테이션 계층에 반환

##### DTO만 반환

엔티티 대신에 단순히 데이터만 전달하는 객체인 DTO를 생성해서 반환

#### 13.3.2 스프링 OSIV: 비지니스 계층 트랜잭션