## 8. 프록시와 연관관계 관리

### 8.1 프록시

엔티티가 실제 사용될 때까지 데이터베이스 조회를 지연하는 방법을 제공하는데 이를 지연 로딩이라한다. 지연 로딩 기능을 사용하려면 실제 엔티티 객체 대신에 데이터베이스 조회를 지연할 수 있는 가짜 객체가 필요한데 이것을 프록시 객체라 한다.

#### 8.1.1 프록시 기초

`em.find(Member.class, 1L)` 이렇게 엔티티를 직접 조회하면 조회한 엔티티를 실제 사용하든 사용하지 않든 데이터베이스를 조회하게 된다.

`em.getReference(Member.class, 1)` 을 사용하면 데이터베이스를 조회하지 않고 실제 엔티티 객체도 생지 않고 데이터베이스 접근을 위임한 프록시 객체를 반환한다.

#### 8.1.2 프록시와 식별자

엔티티를 프록시로 조회할때 식별자 값을 파라미터로 전달하는데 프록시 객체는 이 식별자 값을 보관한다. 프록시 객체는 식별자 값을 가지고 있으므로 식별자 값을 조회하는 `team.getId()` 를 호출해도 프록시를 초기화하지 않는다. 단 엔티티 접근 방식을 프로퍼티(`@Access(AccessType.PROPERTY)`)로 설정한 경우에만 초기화 하지 않는다.

엔티티 접급 방식을 필드(`@Access(AccessTYpe.FIELD)`)로 설정하면 JPA는 `getId()`메소드가 id만 조회하는 메소드인지 다른 필드까지 활용해서 어떤 이를 하는 메소드인지 알지 못하므로 프록시 객체를 초기화한다.

#### 8.1.3 프록시 확인

`PersistenceUnitUtil.isLoaded(Object entity)`  메소드를 사용하면 프록시 인스턴스의 초기화 여부를 확인할 수 있다.

### 8.2 즉시 로딩과 지연 로딩

JPA는 개발자가 연관된 엔티티의 조회 시점을 선택할 수 있도록 다음 두 가지 방법을 제공한다.

- 즉시로딩
  - 엔티티를 조회할 때 연관된 엔티티도 함께 조회한다
  - `FetchType.EAGER` 로 설정
- 지연로딩
  - 엔티티를 실제 사용하는 시점에 JPA가 SQL을 호출해서 팀 엔티티를 조회한다
  - `FetchType.LAZY`로 조회

#### 8.2.1 즉시로딩

조인쿼리를 사용하여 쿼리 한번으로 두 엔티티를 모두 조회한다.

즉시 로딩 실행시 JPA가 `INNER JOIN` 이 아닌 외부 조인을 사용한다. 내부조인을 사용하려면 외래키에 NOT NULL 제약 조건을 설정하면 값이 있는 것을 보장하므로 내부조인만 사용해도된다. `@JoinColumn`  에 `nullable=false` 를 설정하면 외래 키는 NULL 값을 허용하지 않는다고 알려주면 JPA는 외부 조인 대신에 내부 조인을 사용한다.

#### 8.2.2 지연로딩

실제 데이터가 필요한 순간이 되어서야 데이터베이스를 조회해서 프록시 객체를 초기화 한다.

### 8.3 지연 로딩 활용

#### 8.3.1 프록시와 컬렉션 래퍼

하이버네이트는 엔티티를 영속 상태로 만들 때 엔티티에 컬렉션이 있으면 컬렉션을 추적하고 관리할 목적으로 원본 컬렉션을 하이버네이트가 제공하는 내장 컬렉션으로 변경하는데 이것을 컬렉션 래퍼라고 한다.

엔티티를 지연 로딩하면 프록시 객체를 사용해서 지욘 로딩을 수행하지만 컬렉션은 컬렉션 래퍼가 지연 로딩을 처리해준다.

#### 8.3.2 JPA 기본 페치 전략

- `@ManyToOne`, `@OneToOne`

  즉시 로딩

- `@OneToMany`, `@ManyToMany`

  지연 로딩

추천하는 방법은 모든 연관관계에 지연 로딩을 사용하는 것이다. 실제 사용하는 상황을 보고 꼭 필요 한 곳에만 즉시 로딩을 사용하도록 최적화

#### 8.3.3 컬렉션에 `FetchType.EAGER` 사용 시 주의점

- 컬렉션을 하나 이상 즉시 로딩하는 것은 권장하지 않는다

  컬렉션과 조인한다는 것은 데이터 베이스 테이블로 보면 일대다 조인이다.

- 컬렉션 즉시 로딩은 항상 외부 조인을 사용한다

  팀 테이블에서 회원 테이블로 일대다 관계를 조인 할 떄 회원이 한 명도 없는 팀을 내부 조인하면 팀까지 조회가 되지 않는 문제가 발생한다. 따라서 일대다 관계를 즉시 로딩할 때 항상 외부 조인을 사용한다.