## Concurrent Mark Sweep(CMS) Collector

CMS 컬렉터는 더 짧은 가비지 컬렉션 중지 시간과 애플리케이션이 실행되는 동안 가비지 컬렉터와 프로로세스 리소스 공유를 위해 설계 되었다

수명이 긴 데이터 세트가 있고 프로세서가 2개 이상인 시스템에서 실행되는 애플리케이션은 이 수집기를 사용하면 좋다. CMS 컬렉터는 `-XX:+UseConcMarkSweepGC`로 활성화 할 수 있다.

CMS 컬렉터는 deprecated 되었다. 대신에 Garbage-First collector를 사용하는 것이 좋다

### Concurrent Mark Sweep Collector의 성능과 구조

다른 컬렉터와 유사하게, CMS 컬렉터는 세대별 수집기이다. 따라서, 메이저와 마이너 수집이 발생한다. CMS 컬렉터는 별도의 가비지 컬렉터 스레드를 사용하여 애플리케이션 실행과 동시에 사용중인 객체를 추적함으로써 메이저 수집으로 인한 중지  시간을 줄이려고 한다.

메이저 수집 동안에, CMS 컬렉터는 컬렉션 시작시 짧은 시간과, 중간에 다시 모든 애플리케이션 스레드를 일시 중지시킨다. 두번째 정지는 두 일시 중지 중에 더 길다.  여러 스레드가 중지시간에 컬렉션 작업을 수행한다.  하나 또는 하나 이상의 가비지 컬렉터 스레드가 남은 컬렉션 작업을 수행한다. 마이너 컬렉션은 진행중인 메이저 컬렉션과 상호작용할 수 있으며, 마이너 컬렉션은 parallel collector와 유사하게 수행된다(마이너 컬렉션 중에 애플리케이션 스레드가 중지된다) 

### 동시 모드 실패

CMS 컬렉터는 old generation이 가득 차기 전에 수집을 완료하기 위해 응용프로그램 스레드와 동시에 하나 이상의 가비지 컬렉터 쓰레기를 사용한다.

CMS 컬렉터는 대부분의 추적 및 스위핑 작업을 애플리케이션이 돌아가고 있는 중에 하므로 응용 프로그램에서는 짧은 일시 중지 시간만 볼 수 있다. 그러나, old generation이 가득 차기 전에 수집을 완료 할 수 없거나 old generation의 사용가능한 여유공간 블록으로 할당을 충족할 수 없는 경우 응용프로그램이 중지되고 수집이 완료된다. 이를 동시 모드 실패라고 하고 CMS 컬렉터 매개 변수를 조정해야 하는 것을 나타낸다. 동시 수집이 명시작인 수집(`System.gc()`)에 의해 중지되거나 가비지 컬렉션이 진단 도구의 정보가 필요한경우 동시 모드 중단이 보고된다.

### CMS 컬렉터와 플로팅 가비지

CMS 컬렉터는 다른 컬렉터 처럼 힙에 있는 접근 가능한 객체를 추적하는 컬렉터이다.

애플리케이션 스레드와 가비지 컬렉터가 메이져 컬렉션에 동시에 실행되는데, 객체는 컬렉션 프로세스가 끝날때 도달할수 없는 객체가 되는 경우가 있다. 이런 객체를 플로팅 가비지라고 한다.

### CMS 컬렉터 일시 중지

CMS 컬렉터는 동시 수집 중에 애플리케이션을 두번 정지시킨다. 첫번째 일시 중지는 도달할 수 있는 객체를 마크하는 것이고 이를 `initial mark pause` 라고 한다.

두번째 일시 중지는 동시 추적이 끝날때 발생하며 애플리케이션 스레드의  업데이트로 추적이 구락된 객체를 찾는다. 이를 `remark pause` 라고 한다.

### CMS 컬렉터 동시 추적

도달 가능한 객체의 동시 추적은 `initial mark pause` 와 `remark pause` 사이에 일어난다.

동시 추적 단계 에서는 가비지 컬렉터가 하나 또는 그 이상의 스레드는 사용한다. `remark pause` 이후 다음 메어져 컬렉션 전까지 컬렉터는 접근 할 수 없는 객체를 수집한다.

### 동시 수집 사이클 시작

Serial Collecor를 사용하면 old 세대가 가득차면 발생하고 컬랙션이 완료될때 까지 모든 애플리케이션 스레드가 중지된다. 반면에, CMS 컬렉터의 동시 수집은 old 세대가 가득차기 전에 수집이 완료될 수 있어야 한다. 동시 수집이 시작되는 몇가지 방법이 있다.

최근 기록을 기반으로 CMS 컬렉터는 old 세대가 고갈되기 전까지 남은 시간과 동시 수집 사이클에 필요한 시간은 추정한다. 이러한 추정치를 이용하여 old 세대가 고갈되기 전에 수집 사이클을 완료하기 위해 동시 수집 사이클이 시작된다.

old 세대의 사용이 초기 사용률보다 많은 경우에도 동시 수집이 시작된다. 초기 사용률의 임계 값은 기본값으로 92%이다. 이 값은 다음 옵션을 이용해 변경 할 수 있다.

`-XX:CMSInitiatingOccupancyFraction=<N>`