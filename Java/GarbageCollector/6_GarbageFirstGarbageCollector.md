## Garbage-First Garbage Collector

G1(Garbage-First) 가비지 컬렉터는 많은 양의 메모리가 있는 멀티 프로세서 시스템을 대상으로 한다. 최소한의 설정으로 높은 처리향을 달성하면서 가비지 컬랙션 일시 중지 시간 목표를 높은 확률로 달성하고자 한다. G1은 현재 애플리케이션 및 아래의 환경을 대상으로 지연 시간과 처리량 사이의 최상의 균형을 제공하는것을 목표로 한다.

- 힙의 크기는 10 GB이상이며, 50% 이상의 Java 힙은 접근 가능한 데이터가 차지한다.
- 객체 할당과 승격 비율은 시간에 따라 달라질 수 있다.
- 힙에 많은 fragmentation이 존재한다.
- 수백 밀리 초를 넘지 않는 예측 가능한 일시 중지 시간을 목표로, 깁 가비지 컬렉션 일시 중지를 방지한다.

### G1 활성화

Garbage-First 가비지 수집기는 기본 수집기이므로 추가적인 작업이 필요 없다. `-XX:+UseG1GC`를 이용하여 명시적으로 활성화 할 수 있다.

### 기본 개념

G1은 세대별, 증분식, 병렬, 대부분 동시, stop-the-world, 비우기 가비지 컬렉터로, 각각의 stop-the-world 일시 중지 시간안에 일시 중지 시간을 모니터링한다. 다른 컬렉터와 마찬가지로 G1은 힙을 young 세대와 old 세대로 나눈다. 공간 재 확보는 가장 효율적인 young 세대에 집중하고, 적은 빈도로 old 세대에서 공간 재 확보를 한다.

일부 작업은 처리량을 향상 시키기 위해 항상 stop-the-world 일시 중지로 수행된다. *global marking* 같은 전체 힙 작업과 같이 애플리케이션이 중지된 상태에서  더 많은 시간이 걸리는 작업은 애플리케이션과 동시에 수행된다. 공간 재 확보를 위한 stop-the-world 일시 중지 시간을 짧게 유지하기 위해 G1은 공간 재확보를 병렬로 점진적으로 수행한다. G1은 관련 비용 모델을 만들기 위해 이전 애플리케이션 동작 및 일시 중지에 대한 정보를 추적하여 예측한다. 예측 정보를 통해 중지시 작업의 양에 대한 정보를 얻는다.

G1은 evacuation을 사용하여 공간을 회수한다. 선택된 메모리 영역에서 찾은 접근 가능한 객체를 새 메모리 영역으로 복사되어 프로세스에 의해 압축된다.  evacuation 이 완료된 후에, 이전에 접근 가능한 객체가 차지 했던 공간이 애플리케이션에서 할당을 위해 제사용된다.

G1 컬렉터는 real-time 컬렉터가 아니다. 높은 확률로 설정된 일시 중지 시간 목표를 달성하려고 시도한다. 하지만 목표를 달성할지 확신할 수 없다.

#### 힙 레이아웃

G1은 힙을 동일한 크기의 힙 영역으로 분할한다. 각 힙영역은 연속적인 가상 메모리이다. 영역은 메모리 할당 및 메모리 재확보의 단위이다. 이러한 각 영역은 비어 있거나 특정 세대(old 또는 young)에 할당 될 수 있다. 메모리 요청이 들어 오면 메모리 매니져는 사용 가능한 영역을 나눠 준다.

young 세대는 에덴지역과 서바이버 지역을 포함한다. 이러한 영역은 다른 컬렉터에서도 동일한 기능을 제공하지만, G1에서는 이러한 영역이 비연속적인 패턴으로 배치된다. old 세대는 old 지역으로 구성된다. old 세대 지역은 여러 힙 영역일 수 있고 여러개 있다.

old 세대에 직접 할당된 큰 객체를 제외하고는 애플리케이션은 항상 young 세대, 에덴 지역에 할당된다. 

G1 컬렉터 컬렉션 일시 중지는 전체적인 young 세대의 공간을 회수 할 수 있으며 컬렉션 일시 중지시 old세대 영역의 집합을 추가적으로 회수 할 수 있다. 일시 중지 중에 G1은 컬렉션 집합의 객체를 하나 또는 하나 이상의 다른 힙 영역으로 복사한다. young 세대의 살아남은 객체는 old 지역으로 복사되고, old 지역의 객체는 aging을 사용하여 다른 old 지역으로 복사된다.

#### 가비지 컬렉션 사이클

크게 보면, G1 컬렉터는 두 단계를 번갈아 가며 수행한다. young 전용 단계에서는 현재 사용가능한 객체의 메모리를 old 세대로 점진적으로 채우는 가비지 컬렉션이 포함된다. 공간회수 단계에서는 young 세대를 처리하는 것에 추가로, old 세대의 공간을 점진적으로  재확보 하는 단계이다. 그런 다음 다시 young 전용 단계로 다시 시작된다.

다음 목록은 G1 가비지 컬렉션 사이클의 단계사이의 일시중지 변화 등을 자세히 설명한다.

1. young 전용 단계

   이 단계는 일부의 young 세대 컬렉션을 old 세대로 옮기는것으로부터 시작된다. old 세대 점유율이 `Initiating Heap Occupancy`를 넘으면 공간회수 단계에서 young 전용 단계로 전환된다. G1은 `Normal young Collection` 대신, `Concurrent Start young collection`를 스케줄한다.

   - `Concurrent Start`

     Normal young collection을 수행하고 추가적으로 마킹 프로세스를 시작한다. 동시 마킹은 old 세대 영역에서 현재 도달 할 수있는 모든 객체를 다음 공간 회수 단계 동안 유지하도록 결정한다. 컬렉션 마킹이 완전히 완료되지 않아도 Normal young collection이 발생할 수 있다. 마킹은 두 가지 특별한 stop-the-world 일시 중지(`Remark` 와 `Cleanup`)로 완료된다

   - `Remark`

     마킹 자체를 마무리하고 글로벌 참조 처리 및 클래스 언로드를 수행하며 완전히 빈 영역을 회수하고 내부 데이터 구조를 정리한다. `Remark`와 `Cleanup` 사이 G1은 선택된 old 세대 영역에서 여유 공간을 동시에 회수 할 수 있도록 정보를 계산하며, 이는 `Cleanup` 일시 중지에서 마무리된다.

   - `Cleanup`

     공간 회수 단계가 실제로 뒤따를 지 여부를 결정합니다. 공간 재 확보 단계가 뒤 따르면 Young 전용 단계는 단일 Prepare Mixed Young 컬렉션으로 완료된다. 

2. 공간 재 확보 단계

   이 단계는 young 세대 지역 외에도 old 세대 지역 집합의 라이브 객체를 비우는 여러 혼합 컬렉션으로 구성된다. 공간 재 확보 단계는 G1이 더 많은 old 세대 영역을 비워도 충분한 여유 공간을 확보하지 못할 것이라고 판단 할 때 종료된다.

공간 재 확보 후 수집 단계는 다른 young 전용 단계로 다시 시작된다. 살아있는 객체의 정보를 수집하는 동안 애플리케이션의 메모리가 부족하면 G1은 다른 수집기와 마찬가지로 전체 GC (stop-the-world full heap compaction)를 수행한다.